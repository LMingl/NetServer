![](images\服务器框架.png)

### 网络协议：



### IO处理单元
我设计的完成的主要任务：
1.等待并接收新的客户的连接
2.
#### epoll
突破1024限制
ulimit -a 查看
![](images\文件描述符就绪事件.png)
#### 内核事件表
epoll是Linux特有的IO复用函数，epoll使用一组函数来完成任务
epoll需要使用一个额外的文件描述符，来唯一标识内核的事件表
 #include<sys/epoll.h>
 int epoll_create(int size)
 参数：创建的红黑树的监听结点数
 函数返回的文件描述符将用于所有epoll系统的第一个参数，指定要访问的内核事件表
 指向一棵红黑树
int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event)
功能：对红黑树进行操作
参数：
epfd:epoll_create的返回值
op: 指定的操作类型
EPOLL_CTL_ADD:往事件表添加fd上的事件
EPOLL_CTL_MOD:修改fd上的注册事件
EPOLL_CTL_DEL:
struct epoll_event
{
    __uint32_t events;
    epoll_data_t data;
}
event:描述事件类型，
EPOLLIN epoll的数据可读事件   
EPOLLOUT
EPOLLET
EPOLLONESHOT:可以用来避免两个线程读写同一个socket局面
我们期望一个socket任何时刻只能被一个线程操作

epoll_data_t是一个联合体，使用最多的是fd,它指定事件从属的目标文件描述符
int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout)
在一段超时时间等待一组文件描述符上的事件
epoll_wait函数如果检测到事件，就将所有的事件从内核事件表中复制到它的第二个参数evets指定的数组中，该数组只用于输出
timeout:超时时间
-1：阻塞
0：立即返回 非阻塞
>0：指定毫秒
返回值：
>0:返回满足监听的总个数 可作为循环上限
0：没有


##### LT和ET模式
水平触发和边缘触发
当往epoll内核事件表中注册一个文件描述符上的EPOLLET事件时，epoll将会以ET模式操作该文件描述符。
ET:边缘触发只有数据来才触发，不管缓存是否有数据
LT:水平触发只要有数据都会触发
注意：
ET模式为高效模式，但只支持非阻塞模式,如socket为非阻塞







#### 事件处理模式
服务器程序通常需要处理三类事件：IO事件、信号及定时事件

事件处理模式：
- 同步IO模型 Reactor 
- 异步IO模型 Proactor

Reactor模式，它要求主线程（IO处理单元）只负责监听文件描述符上是否有事件发生，有的话立即将该事件通知工作线程（逻辑单元），除此之外主线程不做任何其他实质性的工作。读写数据，接收新的连接，以及处理客户请求均在工作线程中完成
工作流程：p128
Proactor模式，将所有IO操作交给主线程和内核来处理，工作线程仅仅负责业务逻辑

### 逻辑单元
我设计主要完成的任务：
1.接收分析处理客户数据
2.将结果传递给IO处理单元或直接发送给客户

#### 并发模式
并发模式是指I/O单元和多个逻辑单元之间协调完成任务的方法

服务器主要有两种并发编程模式：
- 半同步/半异步模式，
- 领导者/追随者模式

并发模式中，“同步”指的是程序完全按照代码序列的顺序执行；“异步”指的是程序的执行需要由系统事件来驱动。常见的系统事件包括中断、信号等
半同步/半异步模式中，同步线程用于处理客户逻辑；异步线程用于处理IO事件

池：
池是一组资源的集合，这组资源在服务器启动之初就被完全创建好并初始化，这称为静态资源分配，当服务器进入正式的运行阶段，即开始处理客户请求时，如果他需要相关的资源，就可以直接从池中获取，无需动态分配。
根据不同的资源类型，池可以分为多种，常见的有内存池、进程池、线程池、连接池。
当我们需要一个工作进程或工作线程来处理新到的客户请求时，我们可以直**接从进程池或线程池取得一个执行实体**，而无需动态的调用fork或pthread_create等函数创建进程或线程
连接池通常用于服务器或服务器集群的内部永久连接。

数据复制：两个进程之间要传递大量的数据时，我们就应该考虑使用共享内存，用指针指出每一行在buff中的位置，而不是复制到另一个缓冲区

### 存储单元 
采用连接池的方式
每个逻辑单元可能都需要频繁的访问本地的某个数据库。
解决方案是使用连接池。连接池是服务器和数据库建立的一组连接的集合。当某个逻辑单元需要访问数据库时，它可以直接从连接池中取得一个连接的实体并使用之。待完成数据库的访问后，逻辑单元将该链接返回连接池
我设计的主要完成的任务：
1.
2.

#### 数据库


